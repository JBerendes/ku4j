//kodmunki utilities
(function(b){if(!b){b={}}cssTest={model:{capabilities:{},testing:{}},persistence:{},views:{},controllers:{}};cssTest.controllers.cssTest=function(l,k){this._model=l;this._view=k.controller(this)};cssTest.controllers.cssTest.prototype={suite:function(k){this._model.suite(k);return this},test:function(k,m,l){return this._model.test(k,m,l);return this},run:function(){this._model.run(this._view.readSuite())},load:function(k){this._model.load(this._view.readUri());return this},clear:function(){this._view.clear();return this},save:function(){this._model.save();return this},close:function(){cssTest.controllers=null;this._model.close();return this}};cssTest.model.capabilities.result=function(){cssTest.model.capabilities.result.base.call(this);this._type="pass";this._text="";this._html=""};cssTest.model.capabilities.result.prototype={isPass:function(){return/pass/i.test(this._type)},isFail:function(){return !this.isPass()},fail:function(){this._type="fail";return this},text:function(k){return this.get("text",k)},html:function(k){return this.get("html",k)},name:function(k){return this.property("name",k)},addPassMessage:function(k){this._addMessage(k,b.str.format('<span class="cssTest-pass">{0}</span>',k));return this},addFailMessage:function(k){this._addMessage(k,b.str.format('<span class="cssTest-fail">{0}</span>',k));return this},_addMessage:function(l,k){this._text+=l+"\n";this._html+=k}};b.ext(cssTest.model.capabilities.result,b.Class);cssTest.model.cssTest=function(k){this._onSuiteSet=b.observer();this._onSuiteAdded=b.observer();this._onLoad=b.observer();this._onRunComplete=b.observer();this._onClose=b.observer();this._onError=b.observer();this._testPlan=k;this._currentSuite};cssTest.model.cssTest.prototype={currentSuite:function(){return this.get("currentSuite")},suite:function(l){var o=this._testPlan,m=o.findSuite(l),k=b.exists(m),n=(k)?m:(new cssTest.model.testing.suite()).name(l);if(!k){this._testPlan.add(n);this._onSuiteAdded.notify(n)}this._currentSuite=n;this._onSuiteSet.notify(n);return this},test:function(k,n,l){var m=this._currentSuite;if(!b.exists(m)){b.exception("null",b.str.format("Current suite is {0}",typeof this._currentSuite))}m.test(k,n,l);return this},load:function(k){if(b.isNullOrEmpty(k)){this._onError.notify("Enter a path to or location of a test suite");return this}b.service().xss().uri(k).call();this._onLoad.notify(k);return this},run:function(l){var k=this._testPlan.run(l);this._onRunComplete.notify(k);return this},close:function(){cssTest.model=null;CSSTESTLOADED=false;this._onClose.notify()},onSuiteSet:function(l,k){this._onSuiteSet.add(l,k);return this},onLoad:function(l,k){this._onLoad.add(l,k);return this},onSuiteAdded:function(l,k){this._onSuiteAdded.add(l,k);return this},onRunComplete:function(l,k){this._onRunComplete.add(l,k);return this},onClose:function(l,k){this._onClose.add(l,k);return this},onError:function(l,k){this._onError.add(l,k);return this}};b.ext(cssTest.model.cssTest,b.Class);cssTest.model.testing.suite=function(){cssTest.model.testing.suite.base.call(this);this._tests=b.list();this._results};cssTest.model.testing.suite.prototype={name:function(k){return this.property("name",k)},testCount:function(){return this._tests.count()},results:function(){return this._results},test:function(k,m,l){this._tests.add(new cssTest.model.testing.test(k,m,l));return this},execute:function(){var k=b.list();this._tests.each(function(l){k.add(l.evaluate().result())});this._results=k;return this}};b.ext(cssTest.model.testing.suite,b.Class);cssTest.model.testing.test=function(k,m,l){cssTest.model.testing.test.base.call(this);var n=b(k)[0];if(!b.exists(n)){throw b.exception("arg",b.str.format("Test cannot find node with selector: {0}",k))}this._dom=b.dom(n);this._properties=b.hash(m);this._name=l||b.uid("cssTest-test");this._result};cssTest.model.testing.test.prototype={name:function(){return this._name},result:function(){return this._result},evaluate:function(){var l=this._dom,k=new cssTest.model.capabilities.result().name(this._name||b.uid("test"));this._properties.each(function(n){var m=(g(n))?e(l,n,name):(h(n))?f(l,n,name):d(l,n,name);if(!m.result){k.fail().addFailMessage(m.message)}else{k.addPassMessage(m.message)}});this._result=k;return this}},b.ext(cssTest.model.testing.test,b.Class);function g(k){return/^(top|left)$/i.test(k.key)}function h(k){return/^(width|height)$/i.test(k.key)}function e(m,o,k){var l=m.offset().toPixel(),n=(/left/i.test(o.key))?l.x():l.y();return a(n,o,k)}function f(m,o,k){var l=m.innerDims().toPixel(),n=(/width/i.test(o.key))?l.x():l.y();return a(n,o,k)}function d(l,n,k){var m=l.style(n.key);if(/^font\-family$/i.test(n.key)){m=m.replace(/"/g,"").split(",")[0]}if(/color/i.test(n.key)){m=(function(){var o=l.style(n.key).replace(/[^\d,]/g,"").split(",");return(o.length==3)?b.color(o[0],o[1],o[2]).toCSS():o})()}return a(m,n,k)}function a(n,m,k){var l={};l.result=m.value==n;l.message=l.result?c(m.key,m.value,n,k):j(m.key,m.value,n,k);return l}function c(m,l,n,k){return i("PASS",m,l,n,k)}function j(m,l,n,k){return i("FAIL",m,l,n,k)}function i(l,n,m,o){var k=(o=="")?"(empty)":o;return b.str.format("{0} | {1}:{2}. Expected: {3}",l,n,k,m)}cssTest.model.testing.testPlan=function(){this._suites=b.dto()};cssTest.model.testing.testPlan.prototype={findSuite:function(k){return this._suites.find(k)},listSuites:function(){return this._suites.listValues()},add:function(k){this._suites.add(k.name(),k);return this},run:function(l){var k=this._suites.find(l);return(b.exists(k))?k.execute().results():null}};b.ext(cssTest.model.testing.testPlan,b.Class);cssTest.persistence.cache=function(k){this._name="CSSTEST_CACHE";this._dto=b.dto.serialize(this._name)||b.dto().name(this._name);this._model=k.onLoad(this.save,this)};cssTest.persistence.cache.prototype={listUris:function(){return this._dto.listValues()},save:function(l){var k=this._dto;k.add(k.count()+1,l).save();return this},erase:function(){this._dto.erase();return this}};b.ext(cssTest.persistence.cache,b.Class);cssTest.views.cssTest=function(k,m,l){this._model=k.onSuiteAdded(this.addSuite,this).onRunComplete(this.displayResults,this).onClose(this.close,this).onError(this._onError,this);this._form=m;this._results=l};cssTest.views.cssTest.prototype={controller:function(k){return this.set("controller",k)},readUri:function(){return this._form.read().find("load")},readSuite:function(){return this._form.read().find("suite")},addSuite:function(k){this._form.addSuite(k)},displayResults:function(k){this._results.display(k);return this},clearResults:function(){return this._results.clear()},close:function(){this._form.clear();this._results.clear();b.dom(b(".cssTest-hud")[0]).detach();cssTest=null}};b.ext(cssTest.views.cssTest,b.Class);cssTest.views.form=function(m,l,k){this._select=b.select(l);this._form=b.form().add("load",b.field(m)).add("suite",this._select);this._message=b.dom(k)};cssTest.views.form.prototype={read:function(){return this._form.read()},write:function(k){this._form.write(k);return this},addSuite:function(l){var k=l.name();this._select.addOption(k,k);return this},notify:function(k){this._message.html(k);return this},clearMessage:function(){this._message.clear();return this},clear:function(){this._form.clear();return this.clearMessage()}};cssTest.views.results=function(k,l){this._indicator=b.dom(k);this._resultsList=b.dom(l)};cssTest.views.results.prototype={indicate:function(k){this._indicator.html(k);return this},display:function(l){var k="";this._pass();l.each(function(m){k+='<div class="cssTest-result-label"><div>'+m.name()+"</div>";k+=m.html();k+="</div>";if(m.isFail()){this._fail()}},this);this._resultsList.html(k);return this},clear:function(){this._resultsList.html("");return this},_pass:function(){this._indicator.removeClass("fail");this._indicator.addClass("pass")},_fail:function(){this._indicator.removeClass("pass");this._indicator.addClass("fail")}};b.ext(cssTest.views.results,b.Class)})($);